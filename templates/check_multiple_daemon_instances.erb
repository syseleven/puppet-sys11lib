#!/usr/bin/env bash

##
## WARNING: This file is auto-generated by puppet!
## WARNING: To change it, edit the file in <%= file[/.*\/(.*?\/templates\/.*)/, 1] %>
##

##
## config
##
out=/tmp/check_multiple_daemons.state; printf '' > "${out}"
alert=false

##
## check daemons for multiple instances
##
for d in <%= @daemons %>; do
  c="$(pgrep -lP1 | grep -c " ${d}\$")"
  [[ ${c} -gt 1 ]] && \
    printf '%s is running %s times\n' "${d}" "${c}" >> "${out}" && \
    alert=true
done

##
## alert if necessary
##
[[ ${alert} == true ]] && \
  printf 'CRITICAL: Found multiple daemon instances\n' "${alert}" && \
  cat "${out}" && \
  exit 2
printf 'OK: Cannot find multiple daemon instances\n'
exit 0

