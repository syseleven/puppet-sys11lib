#!/usr/bin/env bash

# WARNING: This file is auto-generated by puppet!
# WARNING: To change it, edit the file in <%= file[/.*\/(.*?\/templates\/.*)/, 1] %>

# config
resultfile=/var/cache/ssl/last.result

# nrpe return codes
nrpe_ok=0
nrpe_wa=1
nrpe_cr=2
nrpe_un=3

# is file existing?
if [ ! -f ${resultfile} ]; then
  printf "WARNING - resultfile doesn't exist\n"
  exit ${nrpe_wa}
fi

# is timestamp ok?
timestamp=$(grep 'TIMESTAMP:' ${resultfile} | sed 's#.*:##g;')
if [ "$(date +%F -d "UTC 1970-01-01 ${timestamp} secs")" != "$(date +%F)" ]; then
  printf "WARNING - resultfile is too old\n"
  exit ${nrpe_wa}
fi

# return result from file
case $(grep 'RETURNCODE' ${resultfile} | sed 's#RETURNCODE:##g;') in
  ${nrpe_ok})  printf "OK - ";;
  ${nrpe_wa})  printf "WARNING - ";;
  ${nrpe_cr})  printf "CRITICAL - ";;
  *)           printf "UNKNOWN - ";;
esac

grep -v "^TIMESTAMP\|^RETURNCODE" ${resultfile}
exit $(grep 'RETURNCODE' ${resultfile} | sed 's#RETURNCODE:##g;')

